# microCMS APIスキーマ設定ガイド（管理画面操作手順）

このガイドでは、microCMSの管理画面で実際にAPIスキーマを設定する手順を、画面操作に沿って説明します。

## 📋 前提条件

- microCMSアカウントを作成済み
- サービスを作成済み
- 管理画面にログインしている状態

## 🎯 ステップ1: エンドポイント作成

### 1-1. エンドポイント作成画面へ移動

1. 管理画面の左サイドバーから「**API設定**」をクリック
2. 「**新規APIを作成**」ボタンをクリック

### 1-2. 基本情報を入力

以下の情報を入力：

- **API ID**: `playlists`
  - ⚠️ 重要: 半角英数字とアンダースコア（`_`）のみ使用可能
  - 小文字推奨
  
- **表示名**: `プレイリスト`
  - 管理画面での表示名（日本語可）

- **説明**: `月ごとのプレイリストデータを管理`
  - 任意（後から変更可能）

### 1-3. API種別の選択

- 「**リスト型**」を選択（デフォルト）
  - 複数のプレイリストを管理するため

### 1-4. 作成

「**作成**」ボタンをクリック

---

## 🔧 ステップ2: フィールド追加

エンドポイント作成後、自動的にフィールド設定画面が表示されます。
もし表示されていない場合は、「**フィールドを追加**」ボタンをクリックしてください。

### 2-1. `year` フィールド（年）

1. 「**フィールドを追加**」をクリック
2. フィールドタイプ選択画面で「**数値**」を選択
3. 以下の設定を入力：

   **基本設定タブ**:
   - **フィールドID**: `year`
   - **表示名**: `年`
   - **説明**: `プレイリストの年（例: 2025）`
   - **必須項目**: ✅ **ON**にする
   - **一覧に表示**: ✅ ON（推奨）

   **詳細設定タブ**:
   - **数値タイプ**: 「**整数**」を選択
   - **デフォルト値**: 空欄のまま

4. 「**保存**」をクリック

### 2-2. `month` フィールド（月）

1. 「**フィールドを追加**」をクリック
2. 「**数値**」を選択
3. 以下の設定を入力：

   **基本設定タブ**:
   - **フィールドID**: `month`
   - **表示名**: `月`
   - **説明**: `プレイリストの月（1-12、特別な場合は文字列も可）`
   - **必須項目**: ✅ **ON**
   - **一覧に表示**: ✅ ON

   **詳細設定タブ**:
   - **数値タイプ**: 「**整数**」を選択
   - **デフォルト値**: 空欄

4. 「**保存**」をクリック

**注意**: 特別なプレイリスト（例: `voca_winter`）がある場合、後で文字列として入力できます。

### 2-3. `yearMonth` フィールド（年月表示）

1. 「**フィールドを追加**」をクリック
2. 「**文字列（1行）**」を選択
3. 以下の設定を入力：

   **基本設定タブ**:
   - **フィールドID**: `yearMonth`
   - **表示名**: `年月表示`
   - **説明**: `表示用の年月文字列（例: "2025.09"）`
   - **必須項目**: ✅ **ON**
   - **一覧に表示**: ✅ ON

   **詳細設定タブ**:
   - **プレースホルダー**: `2025.09`（参考用）
   - **最大文字数**: 空欄（デフォルト）

4. 「**保存**」をクリック

### 2-4. `publishedAt` フィールド（公開日時）

1. 「**フィールドを追加**」をクリック
2. 「**日時**」を選択
3. 以下の設定を入力：

   **基本設定タブ**:
   - **フィールドID**: `publishedAt`
   - **表示名**: `公開日時`
   - **説明**: `プレイリストの公開日時`
   - **必須項目**: ✅ **ON**
   - **一覧に表示**: ✅ ON

   **詳細設定タブ**:
   - **日付のみ**: ❌ **OFF**（日時を記録するため）
   - **デフォルト値**: 「**現在の日時**」を選択

4. 「**保存**」をクリック

### 2-5. `videos` フィールド（動画リスト）← **重要**

これは**カスタムフィールドグループ（繰り返し）**として設定します。

#### 2-5-1. カスタムフィールドグループの作成

1. 「**フィールドを追加**」をクリック
2. 「**カスタムフィールドグループ**」を選択
3. 基本設定を入力：

   **基本設定タブ**:
   - **フィールドID**: `videos`
   - **表示名**: `動画リスト`
   - **説明**: `動画データの配列`
   - **必須項目**: ✅ **ON**
   - **一覧に表示**: ❌ OFF（配列のため表示しない）

   **詳細設定タブ**:
   - **繰り返し**: ✅ **ON** ← **重要！**
   - **グループID**: `video`（任意、デフォルトでも可）

4. 「**保存**」をクリック

#### 2-5-2. カスタムフィールドグループ内のフィールド追加

「カスタムフィールドグループを設定」または「グループ内にフィールドを追加」をクリックします。

グループ内に以下のフィールドを順番に追加してください：

##### ① `id` フィールド（動画ID）

1. グループ内で「**フィールドを追加**」
2. 「**文字列（1行）**」を選択
3. 設定：

   - **フィールドID**: `id`
   - **表示名**: `動画ID`
   - **説明**: `ニコニコ動画の動画ID（例: sm44500976）`
   - **必須項目**: ✅ **ON**
   - **プレースホルダー**: `sm44500976`

4. 「**保存**」

##### ② `title` フィールド（タイトル）

1. 「**フィールドを追加**」
2. 「**文字列（1行）**」を選択
3. 設定：

   - **フィールドID**: `title`
   - **表示名**: `タイトル`
   - **説明**: `動画のタイトル`
   - **必須項目**: ✅ **ON**

4. 「**保存**」

##### ③ `url` フィールド（URL）

1. 「**フィールドを追加**」
2. 「**文字列（1行）**」を選択
3. 設定：

   - **フィールドID**: `url`
   - **表示名**: `URL`
   - **説明**: `動画の完全URL`
   - **必須項目**: ✅ **ON**
   - **プレースホルダー**: `https://www.nicovideo.jp/watch/sm44500976`

4. 「**保存**」

##### ④ `artist` フィールド（アーティスト名）

1. 「**フィールドを追加**」
2. 「**文字列（1行）**」を選択
3. 設定：

   - **フィールドID**: `artist`
   - **表示名**: `アーティスト名`
   - **説明**: `アーティスト名`
   - **必須項目**: ✅ **ON**

4. 「**保存**」

##### ⑤ `thumbnail` フィールド（サムネイル画像パス）

1. 「**フィールドを追加**」
2. 「**文字列（1行）**」を選択
3. 設定：

   - **フィールドID**: `thumbnail`
   - **表示名**: `サムネイル画像パス`
   - **説明**: `ローカルサムネイル画像のパス`
   - **必須項目**: ❌ **OFF**（オプション）
   - **プレースホルダー**: `/thumbnails/sm44500976.jpg`

4. 「**保存**」

##### ⑥ `ogpThumbnailUrl` フィールド（OGPサムネイルURL）

1. 「**フィールドを追加**」
2. 「**文字列（1行）**」を選択
3. 設定：

   - **フィールドID**: `ogpThumbnailUrl`
   - **表示名**: `OGPサムネイルURL`
   - **説明**: `OGPから取得した高品質サムネイル画像のURL`
   - **必須項目**: ❌ **OFF**（オプション）

4. 「**保存**」

#### 2-5-3. グループ内フィールドの確認

カスタムフィールドグループ内に以下のフィールドが追加されていることを確認：

1. `id` （必須）
2. `title` （必須）
3. `url` （必須）
4. `artist` （必須）
5. `thumbnail` （オプション）
6. `ogpThumbnailUrl` （オプション）

グループ設定画面を閉じ、エンドポイントのフィールド一覧に戻ります。

---

## ✅ ステップ3: フィールド順序の確認

フィールド一覧で、以下の順序になっていることを確認してください：

1. `year` （年）
2. `month` （月）
3. `yearMonth` （年月表示）
4. `videos` （動画リスト）← カスタムフィールドグループ
5. `publishedAt` （公開日時）

順序はドラッグ&ドロップで変更できます。

---

## 🔍 ステップ4: 設定の確認

### 4-1. フィールド設定の最終確認

各フィールドが以下の設定になっているか確認：

| フィールドID | タイプ | 必須 | 繰り返し |
|------------|--------|------|---------|
| `year` | 数値（整数） | ✓ | - |
| `month` | 数値（整数） | ✓ | - |
| `yearMonth` | 文字列（1行） | ✓ | - |
| `videos` | カスタムフィールドグループ | ✓ | ✅ ON |
| `publishedAt` | 日時 | ✓ | - |

### 4-2. API設定の確認

1. 「**API設定**」→「**APIの詳細**」をクリック
2. 以下を確認：

   - **API URL**: `https://{サービスID}.microcms.io/api/v1/playlists`
   - **取得**: ✅ 有効
   - **一覧取得**: ✅ 有効
   - **作成**: ✅ 有効（開発時のみ必要）
   - **更新**: ✅ 有効（開発時のみ必要）
   - **削除**: ✅ 有効（開発時のみ必要）

---

## 🧪 ステップ5: テストデータの作成

設定が完了したら、テスト用に1件データを作成して動作確認しましょう。

### 5-1. コンテンツ作成

1. 管理画面左サイドバーから「**コンテンツ**」→「**playlists**」をクリック
2. 「**新規作成**」ボタンをクリック
3. 以下のように入力：

   - **年**: `2025`
   - **月**: `9`
   - **年月表示**: `2025.09`
   - **公開日時**: 現在の日時（自動入力される）
   - **動画リスト**: 
     - 「**追加**」をクリック
     - 動画1件分のデータを入力：
       - **動画ID**: `sm44500976`
       - **タイトル**: `パヘル・マータの音と機微 / 夏色花梨・四国めたん・楚瓷・嗒啦啦`
       - **URL**: `https://www.nicovideo.jp/watch/sm44500976`
       - **アーティスト名**: `いふみ`
       - **サムネイル画像パス**: `/thumbnails/sm44500976.jpg`（任意）
       - **OGPサムネイルURL**: （任意、空欄でも可）

4. 「**公開する**」または「**下書き保存**」をクリック

### 5-2. APIレスポンスの確認

1. 「**API設定**」→「**playlists**」→「**APIプレビュー**」をクリック
2. APIレスポンスが正しく返されるか確認

期待されるレスポンス例：

```json
{
  "contents": [
    {
      "id": "xxx",
      "createdAt": "2025-01-XX...",
      "updatedAt": "2025-01-XX...",
      "publishedAt": "2025-09-01T00:00:00.000Z",
      "revisedAt": "2025-01-XX...",
      "year": 2025,
      "month": 9,
      "yearMonth": "2025.09",
      "videos": [
        {
          "id": "sm44500976",
          "title": "パヘル・マータの音と機微 / 夏色花梨・四国めたん・楚瓷・嗒啦啦",
          "url": "https://www.nicovideo.jp/watch/sm44500976",
          "artist": "いふみ",
          "thumbnail": "/thumbnails/sm44500976.jpg",
          "ogpThumbnailUrl": "..."
        }
      ]
    }
  ],
  "totalCount": 1,
  "offset": 0,
  "limit": 10
}
```

---

## ⚠️ よくある質問とトラブルシューティング

### Q: `videos`フィールドで繰り返しができない

**A**: カスタムフィールドグループの詳細設定で「**繰り返し: ON**」になっているか確認してください。

### Q: フィールドIDを間違えた

**A**: フィールド設定画面で「編集」から変更できます。ただし、一度データを作成した後は変更に注意が必要です。

### Q: `month`フィールドで文字列（例: "voca_winter"）を使いたい

**A**: 数値フィールドの場合、文字列は入力できません。以下のいずれかで対応：

1. **文字列フィールドに変更**: `month`フィールドを文字列（1行）に変更
2. **別フィールドを追加**: `monthSpecial`のような文字列フィールドを追加

推奨: 数値のままにして、特別な場合は`yearMonth`フィールドで管理（例: `2025.voca_winter`）

### Q: APIレスポンスに`videos`が空配列になっている

**A**: カスタムフィールドグループ内のフィールド設定を確認してください。特に：
- フィールドIDが正しいか
- 必須項目の設定が適切か

### Q: テストデータを作成したがAPIで取得できない

**A**: 以下を確認：
- 「**公開する**」をクリックしたか（下書きのままでは取得できない場合がある）
- APIキーが正しいか
- API URLが正しいか

---

## 📝 次のステップ

APIスキーマの設定が完了したら：

1. APIキーの取得（読み取り専用）
2. 環境変数の設定（`.env.local`）
3. 実装コードの作成（`src/lib/microcms.ts`、`src/lib/api/playlists.ts`）
4. 既存JSONデータの移行

詳細は `MICROCMS_MIGRATION_PLAN.md` を参照してください。

