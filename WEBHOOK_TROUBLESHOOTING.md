# Webhook連携トラブルシューティング

## よくある失敗原因と解決方法

### 1. microCMSのWebhook送信が失敗している

#### 確認方法
1. microCMS管理画面 → **「API設定」** → **「Webhook」**
2. 該当するWebhookをクリック
3. **「送信履歴」** を確認

#### エラーパターン

**A. HTTP 404エラー**
- **原因**: デプロイフックURLが間違っている、または削除されている
- **解決策**: 
  - Cloudflare PagesでデプロイフックURLを再確認
  - 新しいデプロイフックを作成し直す

**B. HTTP 401/403エラー**
- **原因**: 認証エラー（デプロイフックURLに問題がある）
- **解決策**: 
  - デプロイフックURLを正確にコピーしているか確認
  - URLの末尾に不要な文字や改行が含まれていないか確認

**C. HTTP 500エラー**
- **原因**: Cloudflare側の一時的なエラー
- **解決策**: 
  - 少し時間を置いて再試行
  - Cloudflare Pagesのステータスページを確認

### 2. ビルドが開始されない

#### 確認方法
1. Cloudflare Pagesダッシュボード → **「デプロイ」** タブ
2. 最新のデプロイメントを確認

#### 原因と解決策

**A. デプロイフックが正しく設定されていない**
- デプロイフックURLが正しくコピーされているか確認
- microCMSのWebhook URLフィールドに完全なURLが入力されているか確認

**B. ブランチ名が間違っている**
- デプロイフックの設定で「ビルドするブランチ」が `main` になっているか確認
- GitHubのデフォルトブランチが `main` か確認

**C. Webhookの通知タイミングが間違っている**
- microCMSのWebhook設定で「コンテンツ公開時」「コンテンツ更新時」が有効になっているか確認

### 3. ビルドは開始されるが失敗する

#### 確認方法
1. Cloudflare Pagesダッシュボード → **「デプロイ」** タブ
2. 失敗したデプロイメントをクリック
3. **「ビルドログ」** を確認

#### よくあるビルドエラー

**A. 環境変数が設定されていない**
- `MICROCMS_SERVICE_DOMAIN` や `MICROCMS_API_KEY` がCloudflare Pagesの環境変数に設定されているか確認
- Cloudflare Pages → **「設定」** → **「環境変数」** を確認

**B. Node.jsのバージョンが古い**
- エラー: `You are using Node.js 18.17.0. For Next.js, Node.js version "^18.18.0 || ^19.8.0 || >= 20.0.0" is required.`
- **解決策**:
  1. Cloudflare Pagesダッシュボード → **「設定」** → **「環境変数」**
  2. 環境変数を追加: `NODE_VERSION=20`
  3. または、プロジェクトルートの `.nvmrc` ファイルに `20` を記述（既に設定済み）

**B. ビルドコマンドのエラー**
- `package.json` の `build` スクリプトが正しく設定されているか確認
- ローカルで `npm run build` が成功するか確認

**C. 依存関係のエラー**
- `pnpm-lock.yaml` または `package-lock.json` が最新であるか確認
- パッケージマネージャーが正しく設定されているか確認（pnpmを使用している場合）

### 4. デプロイフックURLが表示されない/見つからない

#### 確認方法
1. Cloudflare Pages → **「設定」** → **「ビルドとデプロイ」**
2. **「デプロイフック」** セクションを確認

#### 解決策

**A. デプロイフックが作成されていない**
- **「デプロイフックを作成」** をクリックして新規作成

**B. デプロイフックURLが見えない**
- 既存のデプロイフックがある場合、一度削除して新規作成
- ⚠️ URLは作成時に一度しか表示されないため、必ずコピーしておく

**C. 権限の問題**
- Cloudflareアカウントに適切な権限があるか確認
- プロジェクトのオーナーまたは管理者権限が必要

### 5. デバッグ方法

#### 手動でWebhookをテストする

```bash
# curlでデプロイフックURLにPOSTリクエストを送信
curl -X POST "YOUR_DEPLOY_HOOK_URL"

# レスポンスを確認
# 成功: {"success": true, "message": "Deployment triggered"}
# 失敗: エラーメッセージが返される
```

#### microCMSのWebhook送信をテストする

1. microCMS管理画面 → **「API設定」** → **「Webhook」**
2. 該当するWebhookを選択
3. **「テスト送信」** をクリック（機能があれば）
4. 送信履歴で結果を確認

### 6. ログの確認箇所

1. **microCMS側**
   - 管理画面 → **「API設定」** → **「Webhook」** → 送信履歴
   - 送信時刻、HTTPステータスコード、レスポンスを確認

2. **Cloudflare Pages側**
   - ダッシュボード → **「デプロイ」** タブ
   - ビルド開始時刻、ビルドログ、エラーメッセージを確認

### 7. よくある設定ミス

- ❌ URLの末尾に改行やスペースが含まれている
- ❌ `https://` が抜けている
- ❌ デプロイフックURLとAPIエンドポイントURLを混同している
- ❌ Webhookの通知タイミングが無効になっている
- ❌ 環境変数がCloudflare Pagesに設定されていない

### 8. 段階的な確認手順

1. ✅ Cloudflare Pagesでデプロイフックが作成されているか
2. ✅ デプロイフックURLが正しくコピーされているか
3. ✅ microCMSのWebhook URLが正しく設定されているか
4. ✅ 通知タイミングが有効になっているか
5. ✅ microCMSでコンテンツを更新してWebhookが送信されるか
6. ✅ Cloudflare Pagesでビルドが開始されるか
7. ✅ ビルドが成功するか（失敗する場合はログを確認）

各ステップで問題が見つかったら、該当するセクションを参照してください。

